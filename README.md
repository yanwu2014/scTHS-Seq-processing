# scTHS-Seq-processing
Scripts for generating a peaks by cells chromatin accessibility matrix from the scTHS-Seq method. See the following publication (https://www.nature.com/articles/nbt.4038) for a description of the experimental methodology 

## Required packages
These scripts require python2.7 and an R version >= 3.4

For the python scripts install:
* pysam(https://pysam.readthedocs.io/en/latest/) with `pip install pysam --user`

For the R scripts install:
* devtools(https://cran.r-project.org/web/packages/devtools/index.html) with `install.packages("devtools")`
* A custom version of the Kharchenko lab spp(https://github.com/hms-dbmi/spp) using `devtools::install_github('yanwu2014/spp', build_vignettes = FALSE)`
* Bioconductor(http://www.bioconductor.org/install/), if not already installed, using:\
  `source("https://bioconductor.org/biocLite.R")`\
  `biocLite()`
* GenomicRanges using: `biocLite("GenomicRanges")`
* IRanges using: `biocLite("IRanges")`
* Mouse genome with repeats masked using: `biocLite("BSgenome.Mmusculus.UCSC.mm10.masked")`
* Human genome with repeats masked using: `biocLite("BSgenome.Hsapiens.UCSC.hg38.masked")`
* Rsubread using: `biocLite("Rsubread")`

You will also need to generate or download bwa(http://bio-bwa.sourceforge.net/bwa.shtml) indexes for your desired human or mouse reference genome.

## Usage

### Download and setup working directory
1. Clone repository into desired local directory: `git clone git@github.com:yanwu2014/scTHS-Seq-processing.git`
2. Move `i5_scTHS`, `i7_scTHS`, `r5_scTHS` into working directory. These files contain the i5, i7, and r5 index barcodes and will be used to build the space of all possible barcode combinations.

### Align and demultiplex cells
The starting point for this pipeline are un-demultiplexed fastq files, including a read1, index1, and index2 fastq files. If you are starting from basecalls (bcl files), you can generate un-demultiplexed fastq files using Illumina's bcl2fastq(https://support.illumina.com/sequencing/sequencing_software/bcl2fastq-conversion-software.html) without a sample sheet using the command: `bcl2fastq -o [output_directory] --use-bases-mask y50,i8,i32 --create-fastq-for-index-reads 2`

The `align_demultiplex.py` script will take in as input un-demultiplexed fastqs and generate a directory of demultiplexed bam files, one for each potential cell, with PCR duplicate reads removed. The usage is:\
`python align_demultiplex.py [read1_fastq]_R1.fastq.gz [index1_fastq]_I1.fastq.gz [index2_fastq]_I2.fastq.gz [sample_prefix] [bwa_index_path] [n_cores]`

A more in-depth description of each argument:
1. `[read1_fastq]_R1.fastq.gz` is the un-demultiplexed Read1 fastq file
2. `[index1_fastq]_I1.fastq.gz` is the un-demultiplexed I7 index fastq file
3. `[index2_fastq]_I2.fastq.gz` is the un-demultiplexed I5/R5 index fastq file
4. `[sample_prefix]` is the name of your sample (i.e something like `human-cortex`)
5. `[bwa_index_path]` is the path to the bwa index to align reads to
6. `[n_cores]` is the number of cores to use for multithreading

### Split samples (optional)
The scTHS-Seq protocol enables multiple samples to be processed on the same plate, indicated by the r5 indexes. Given a text file of r5 indexes, `split_samples.py` copies all cells with those r5 indexes into a new directory. The usage is:\
`python split_samples.py [demultiplexed_bams_directory] [r5_index_file].txt [new_bams_directory]`

### Call peaks using spp
We use the spp R package developed by Peter Kharchenko to call accessible peaks. `spp_call_peaks_hg38.R` and `spp_call_peaks_mm10.R` take in one or more directories of demultiplexed bam files and generate both a bed and a gtf file of accessible peaks. The usage is:\
`Rscript spp_call_peaks_hg38.R [sample_prefix] [n_cores] [min_unique_reads] [demultiplexed_bams_dir1] [demultiplexed_bams_dir2] ...`

`[min_unique_reads]` specifies the number of unique reads a bam file needs to have in order to be included in peak calling. The script can also take in multiple demultiplexed bam directories to call peaks across multiple samples. 

### Generate peaks by cells matrix
We use the FeatureCounts function in the Rsubreads package to count reads in peaks for each cell. Given a list of bam files and a peaks file in gtf format, `count_reads.R` generates a `.RData` file with the sparse counts matrix and a vector of the fraction of reads in peaks for each cell. The usage is:\
`Rscript count_reads.R [bams_to_use].txt [peaks].gtf [sample_prefix] [n_cores]`

Where:
1. `[bamfiles_pass_filter].txt` is a text file listing all the bam files meeting the minimum unique reads threshold generated by `spp_call_peaks`
2. `[peaks].gtf` is the peaks file generated by `spp_call_peaks`
3. `[sample_prefix]` is the name of your sample
4. `[n_cores]` is the number of cores to use for multithreading


